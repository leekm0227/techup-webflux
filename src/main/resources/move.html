<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<script type="text/babel">
    const View = () => {
        const offset = 20
        let ws = null;
        const [id, setId] = React.useState()
        const [users, setUsers] = React.useState({})
        const usersRef = React.useRef(users)
        const idRef = React.useRef(id)
        const canvasRef = React.useRef(null)

        React.useEffect(() => {
            ws = connServer()
            window.addEventListener("keydown", handleKeyDown)
            return () => window.removeEventListener("keydown", handleKeyDown)
        }, [])

        React.useEffect(() => {
            usersRef.current = users
            const canvas = canvasRef.current
            const context = canvas.getContext('2d')
            const size = 10;
            context.fillStyle = '#e0e0e0'
            context.fillRect(0, 0, canvas.width, canvas.height);
            Object.keys(users).map((key) => {
                let user = users[key]
                context.fillStyle = user.id !== id ? 'rgba(92,92,92,' + user.hp[0] / 10 + ')' : 'rgba(200,50,50,' + user.hp[0] / 10 + ')';
                context.fillRect((user.pos[0] * size) + offset, (user.pos[1] * size) + offset, (size), (size))
            })
        }, [users])

        const handleKeyDown = (e) => {
            if (!ws) {
                console.log("ws null")
                return
            }

            let data = {
                "payloadType": 2,
                "receiveType": 1,
                "regTime": new Date().getTime(),
                "dir": [0, 0],
            }

            switch (e.key) {
                case "ArrowDown":
                    data.dir = [0, 1]
                    ws.send(JSON.stringify(data));
                    break;
                case "ArrowUp":
                    data.dir = [0, -1]
                    ws.send(JSON.stringify(data));
                    break;
                case "ArrowRight":
                    data.dir = [1, 0]
                    ws.send(JSON.stringify(data));
                    break;
                case "ArrowLeft":
                    data.dir = [-1, 0]
                    ws.send(JSON.stringify(data));
                    break;
                case " ":
                    let users = usersRef.current
                    let id = idRef.current
                    let targetId = ""
                    Object.keys(users).map((key) => {
                        let user = users[key]
                        if (users[id] !== undefined && id !== user.id && calDis(users[id].pos, user.pos) < 2) targetId = user.id
                    })

                    data.payloadType = 3
                    data.targetId = targetId
                    ws.send(JSON.stringify(data));
                    break;
            }
        }

        const calDis = (pos1, pos2) => {
            let x = pos1[0] - pos2[0]
            let y = pos1[1] - pos2[1]
            let result = Math.sqrt(Math.abs(x * x) + Math.abs(y * y))
            return result
        }

        const connServer = () => {
            let conn = new WebSocket("ws://localhost:22222/channel");
            conn.onopen = () => {
                console.log("on open");
                conn.send(JSON.stringify({"payloadType": 1, "regTime": new Date().getTime()}));
            }

            conn.onmessage = (msg) => {
                let data = JSON.parse(msg.data);

                switch (data.payloadType) {
                    case "ATTACK":
                        setUsers((users) => {
                            let user = users[data.sessionId]
                            user.hp = data.player.hp
                            return {...users, [data.sessionId]: user}
                        })
                        break;
                    case "DEAD":
                        if (data.sessionId === idRef.current) {
                            alert("died...")
                            // location.reload()
                            return
                        }

                        setUsers((users) => {
                            delete users[data.sessionId]
                            return {...users}
                        })
                        break;
                    case "SPAWN":
                        setUsers((users) => {
                            return {...users, [data.sessionId]: data.player}
                        })
                        break;
                    case "MOVE":
                        setUsers((users) => {
                            let user = users[data.sessionId]
                            user.pos = data.player.pos
                            return {...users, [data.sessionId]: user}
                        })
                        break;
                    case "INIT":
                        setId(data.id)
                        idRef.current = data.id
                        setUsers(data.players)
                        break;
                }
            }

            conn.onclose = () => {
                alert("disconnected");
            }

            return conn
        }

        return (
            <div>
                <canvas width="1050" height="1050" ref={canvasRef}/>
            </div>
        )
    }

    ReactDOM.render(<View/>, document.querySelector("#root"))
</script>
<body>
<div id="root"></div>
</body>
