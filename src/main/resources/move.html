<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<script type="text/babel">
    const View = () => {
        const offset = 20
        let conn = null
        const [users, setUsers] = React.useState([])
        const canvasRef = React.useRef(null)

        React.useEffect(() => {
            const canvas = canvasRef.current
            const context = canvas.getContext('2d')

            context.fillStyle = '#e0e0e0'
            context.fillRect(0, 0, canvas.width, canvas.height);
            context.fillStyle = '#5c5c5c'

            users.map((user) => {
                context.fillRect(user.pos[0] + offset, user.pos[1] + offset, 5, 5)
            })
        }, [users])

        const start = () => {
            if (conn != null) return

            let ws = new WebSocket("ws://localhost:22222/channel");
            ws.onopen = () => {
                console.log("on open");
                ws.send(JSON.stringify({"payloadType": 7}));
            }

            ws.onmessage = (msg) => {
                let data = JSON.parse(msg.data);
                if (data.payloadType === "MOVE") {
                    setUsers((users) => {
                        let target = users.findIndex((user) => (user !== undefined && user.sessionId === data.sessionId))
                        target > -1 ? users[target] = data : users.push(data)
                        users = users.filter(x => x != null)

                        return [...users]
                    })
                }
            }

            ws.onclose = () => {
                alert("disconnected");
            }

            conn = ws
        }

        return (
            <div>
                <button onClick={() => start()}>conn</button>
                <canvas width="1050" height="1050" ref={canvasRef}/>
            </div>
        )
    }

    ReactDOM.render(<View/>, document.querySelector("#root"))
</script>
<body>
<div id="root"></div>
</body>
